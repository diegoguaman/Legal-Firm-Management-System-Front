<div class="case-list-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>Lista de Casos</mat-card-title>
    </mat-card-header>
    
    <mat-card-content>
      <!-- Loading State -->
      @if (loading$ | async) {
        <div class="loading-container">
          <mat-spinner diameter="50"></mat-spinner>
          <p>Cargando casos...</p>
        </div>
      }

      <!-- Error State -->
      @if (error$ | async; as error) {
        <div class="error-container">
          <p class="error-message">Error: {{ error }}</p>
        </div>
      }

      <!-- Case List -->
      @if (!(loading$ | async) && !(error$ | async)) {
        <div class="table-container">
          <!-- Actions Bar -->
          <div class="actions-bar">
            <button mat-raised-button color="primary" routerLink="/cases/new">
              <mat-icon>add</mat-icon>
              Nuevo Caso
            </button>
            
            <mat-form-field appearance="outline" class="filter-field">
              <mat-label>Buscar</mat-label>
              <input matInput (input)="applyFilter($event)" placeholder="Número de caso, cliente...">
              <mat-icon matPrefix>search</mat-icon>
            </mat-form-field>
          </div>

          <!-- Filters -->
          <div class="filters-bar">
            <mat-form-field appearance="outline">
              <mat-label>Materia</mat-label>
              <mat-select [(ngModel)]="selectedMatter">
                @for (option of matterOptions; track option.value) {
                  <mat-option [value]="option.value">{{ option.label }}</mat-option>
                }
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Estado</mat-label>
              <mat-select [(ngModel)]="selectedStatus">
                @for (option of statusOptions; track option.value) {
                  <mat-option [value]="option.value">{{ option.label }}</mat-option>
                }
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Cliente</mat-label>
              <mat-select [(ngModel)]="selectedClientId">
                <mat-option value="ALL">Todos</mat-option>
                @for (client of clients$ | async; track client.id) {
                  <mat-option [value]="client.id">
                    {{ client.first_name }} {{ client.last_name }}
                  </mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>

          <!-- Table -->
          <table mat-table [dataSource]="(cases$ | async) || []" class="cases-table">
            <!-- Case Number Column -->
            <ng-container matColumnDef="case_number">
              <th mat-header-cell *matHeaderCellDef>Número</th>
              <td mat-cell *matCellDef="let caseItem">{{ caseItem.case_number }}</td>
            </ng-container>

            <!-- Client Column -->
            <ng-container matColumnDef="client">
              <th mat-header-cell *matHeaderCellDef>Cliente</th>
              <td mat-cell *matCellDef="let caseItem">
                @if (clients$ | async; as clients) {
                  {{ getClientName(caseItem.client_id, clients) }}
                }
              </td>
            </ng-container>

            <!-- Matter Column -->
            <ng-container matColumnDef="matter">
              <th mat-header-cell *matHeaderCellDef>Materia</th>
              <td mat-cell *matCellDef="let caseItem">
                <span [class]="'badge-' + caseItem.matter.toLowerCase()">
                  {{ caseItem.matter }}
                </span>
              </td>
            </ng-container>

            <!-- Status Column -->
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Estado</th>
              <td mat-cell *matCellDef="let caseItem">
                <span [class]="'badge-status-' + caseItem.status.toLowerCase().replace('_', '-')">
                  {{ caseItem.status.replace('_', ' ') }}
                </span>
              </td>
            </ng-container>

            <!-- Opened At Column -->
            <ng-container matColumnDef="opened_at">
              <th mat-header-cell *matHeaderCellDef>Fecha Apertura</th>
              <td mat-cell *matCellDef="let caseItem">
                {{ caseItem.opened_at | date:'short' }}
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Acciones</th>
              <td mat-cell *matCellDef="let caseItem">
                <button mat-icon-button color="primary" [routerLink]="['/cases', caseItem.id]" (click)="viewCase(caseItem.id)">
                  <mat-icon>visibility</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

            <!-- No data row -->
            <tr class="mat-row" *matNoDataRow>
              <td class="mat-cell" [attr.colspan]="displayedColumns.length">
                <div class="no-data">
                  <mat-icon>folder_open</mat-icon>
                  <p>No hay casos registrados</p>
                </div>
              </td>
            </tr>
          </table>
        </div>
      }
    </mat-card-content>
  </mat-card>
</div>

